/**
 * ä¸‹è½½ç®¡ç†æœåŠ¡
 * æä¾›è¯åº“ã€æ•™ç¨‹ç­‰èµ„æºçš„ä¸‹è½½å’Œç®¡ç†åŠŸèƒ½
 */

interface DownloadResource {
  id: string;
  name: string;
  description: string;
  size: string;
  category: string; // 'dict', 'tutorial', 'audio'
  version: string;
  downloadUrl: string;
  isDownloaded: boolean;
  downloadProgress: number; // 0-100
  downloadedAt?: number;
}

interface DownloadStats {
  totalCount: number;
  downloadedCount: number;
  totalSize: string;
}

interface CategoryItem {
  id: string;
  name: string;
  icon: string;
}

export class DownloadService {
  private static instance: DownloadService;
  private resources: DownloadResource[] = [];
  private downloadingIds: Set<string> = new Set();

  private constructor() {
    this.initializeResources();
  }

  static getInstance(): DownloadService {
    if (!DownloadService.instance) {
      DownloadService.instance = new DownloadService();
    }
    return DownloadService.instance;
  }

  /**
   * åˆå§‹åŒ–å¯ä¸‹è½½èµ„æºåˆ—è¡¨
   */
  private initializeResources(): void {
    this.resources = [
      // è¯åº“èµ„æº
      {
        id: 'dict_basic_001',
        name: 'åŸºç¡€è¯åº“ (3000è¯)',
        description: 'åŒ…å«æ—¥å¸¸ç”¨è¯­ã€é—®å€™ã€åŸºç¡€åŠ¨è¯ç­‰3000ä¸ªå¸¸ç”¨éŸ©æ–‡è¯æ±‡',
        size: '2.5 MB',
        category: 'dict',
        version: '1.0.0',
        downloadUrl: 'https://example.com/dict_basic_3000.zip',
        isDownloaded: false,
        downloadProgress: 0
      },
      {
        id: 'dict_advanced_001',
        name: 'é«˜çº§è¯åº“ (10000è¯)',
        description: 'åŒ…å«å•†åŠ¡ç”¨è¯­ã€å­¦æœ¯è¯æ±‡ã€æˆè¯­ç­‰10000ä¸ªè¿›é˜¶éŸ©æ–‡è¯æ±‡',
        size: '8.5 MB',
        category: 'dict',
        version: '1.0.0',
        downloadUrl: 'https://example.com/dict_advanced_10000.zip',
        isDownloaded: false,
        downloadProgress: 0
      },
      {
        id: 'dict_special_001',
        name: 'ä¸“ä¸šè¯åº“ (åŒ»å­¦/æ³•å¾‹)',
        description: 'åŒ…å«åŒ»å­¦ã€æ³•å¾‹ã€æŠ€æœ¯ç­‰ä¸“ä¸šé¢†åŸŸçš„éŸ©æ–‡è¯æ±‡5000ä¸ª',
        size: '4.2 MB',
        category: 'dict',
        version: '1.0.0',
        downloadUrl: 'https://example.com/dict_special_5000.zip',
        isDownloaded: false,
        downloadProgress: 0
      },

      // æ•™ç¨‹èµ„æº
      {
        id: 'tutorial_hangul_001',
        name: 'éŸ©æ–‡å­—æ¯å®Œæ•´æ•™ç¨‹',
        description: 'åŒ…å«æ‰€æœ‰éŸ©æ–‡å­—æ¯ï¼ˆè¾…éŸ³ã€å…ƒéŸ³ã€åŒå…ƒéŸ³ï¼‰çš„è¯¦ç»†ç¬”é¡ºå’Œå‘éŸ³',
        size: '3.2 MB',
        category: 'tutorial',
        version: '2.0.0',
        downloadUrl: 'https://example.com/tutorial_hangul.zip',
        isDownloaded: false,
        downloadProgress: 0
      },
      {
        id: 'tutorial_grammar_001',
        name: 'åŸºç¡€è¯­æ³•æ•™ç¨‹',
        description: 'åŒ…å«éŸ©æ–‡è¯­æ³•åŸºç¡€ã€æ—¶æ€ã€åŠ©è¯ç­‰å†…å®¹ï¼Œå…±50ä¸ªè¯¾ç¨‹',
        size: '5.1 MB',
        category: 'tutorial',
        version: '1.5.0',
        downloadUrl: 'https://example.com/tutorial_grammar.zip',
        isDownloaded: false,
        downloadProgress: 0
      },

      // å‘éŸ³èµ„æº
      {
        id: 'audio_dict_001',
        name: 'è¯åº“å‘éŸ³åŒ…',
        description: '3000ä¸ªåŸºç¡€è¯æ±‡çš„æ ‡å‡†å‘éŸ³éŸ³é¢‘æ–‡ä»¶',
        size: '45.0 MB',
        category: 'audio',
        version: '1.0.0',
        downloadUrl: 'https://example.com/audio_dict_3000.zip',
        isDownloaded: false,
        downloadProgress: 0
      },
      {
        id: 'audio_phrases_001',
        name: 'å¸¸ç”¨çŸ­è¯­å‘éŸ³åŒ…',
        description: '500ä¸ªå¸¸ç”¨éŸ©æ–‡çŸ­è¯­å’Œè¡¨è¾¾çš„å‘éŸ³éŸ³é¢‘',
        size: '12.5 MB',
        category: 'audio',
        version: '1.0.0',
        downloadUrl: 'https://example.com/audio_phrases_500.zip',
        isDownloaded: false,
        downloadProgress: 0
      }
    ];
  }

  /**
   * è·å–æ‰€æœ‰å¯ä¸‹è½½èµ„æº
   */
  getAllResources(): DownloadResource[] {
    return [...this.resources];
  }

  /**
   * æŒ‰åˆ†ç±»è·å–èµ„æº
   */
  getResourcesByCategory(category: string): DownloadResource[] {
    return this.resources.filter(r => r.category === category);
  }

  /**
   * è·å–å·²ä¸‹è½½çš„èµ„æº
   */
  getDownloadedResources(): DownloadResource[] {
    return this.resources.filter(r => r.isDownloaded);
  }

  /**
   * è·å–å•ä¸ªèµ„æºè¯¦æƒ…
   */
  getResourceById(id: string): DownloadResource | null {
    return this.resources.find(r => r.id === id) || null;
  }

  /**
   * ä¸‹è½½èµ„æº
   */
  async downloadResource(id: string): Promise<boolean> {
    const resource = this.getResourceById(id);
    if (!resource || this.downloadingIds.has(id)) {
      return false;
    }

    this.downloadingIds.add(id);
    resource.downloadProgress = 0;

    try {
      // æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
      return new Promise((resolve) => {
        const interval = setInterval(() => {
          resource.downloadProgress += Math.random() * 30;
          if (resource.downloadProgress >= 100) {
            resource.downloadProgress = 100;
            resource.isDownloaded = true;
            resource.downloadedAt = Date.now();
            this.downloadingIds.delete(id);
            clearInterval(interval);
            resolve(true);
          }
        }, 800);
      });
    } catch (error) {
      console.error('ä¸‹è½½å¤±è´¥:', error);
      this.downloadingIds.delete(id);
      return false;
    }
  }

  /**
   * åˆ é™¤å·²ä¸‹è½½çš„èµ„æº
   */
  deleteResource(id: string): boolean {
    const resource = this.getResourceById(id);
    if (resource && resource.isDownloaded) {
      resource.isDownloaded = false;
      resource.downloadProgress = 0;
      resource.downloadedAt = undefined;
      return true;
    }
    return false;
  }

  /**
   * è·å–ä¸‹è½½ç»Ÿè®¡ä¿¡æ¯
   */
  getDownloadStats(): DownloadStats {
    const downloadedResources = this.getDownloadedResources();
    const stats: DownloadStats = {
      totalCount: this.resources.length,
      downloadedCount: downloadedResources.length,
      totalSize: this.calculateTotalSize(downloadedResources)
    };
    return stats;
  }

  /**
   * è®¡ç®—æ€»å¤§å°
   */
  private calculateTotalSize(resources: DownloadResource[]): string {
    return `${resources.length * 5} MB`;
  }

  /**
   * è·å–èµ„æºåˆ†ç±»åˆ—è¡¨
   */
  getCategories(): CategoryItem[] {
    const categories: CategoryItem[] = [
      { id: 'dict', name: 'è¯åº“', icon: 'ğŸ“š' },
      { id: 'tutorial', name: 'æ•™ç¨‹', icon: 'ğŸ“' },
      { id: 'audio', name: 'å‘éŸ³', icon: 'ğŸ”Š' }
    ];
    return categories;
  }
}

